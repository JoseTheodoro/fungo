name: Deploy to GKE

on:
  push:
    branches:
      - main   # SOMENTE quando merge Ã© feito
  workflow_dispatch:

env:
  PROJECT_ID: fungo-lab
  REGION: us-central1
  CLUSTER: gk3-fungo-cluster
  REPO: fungo-repo
  IMAGE_NAME: fungo

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      #########################################
      # Authenticate with Workload Identity
      #########################################
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/598803461124/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "github-deployer@fungo-lab.iam.gserviceaccount.com"

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      #########################################
      # Docker auth for Artifact Registry
      #########################################
      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev

      #########################################
      # Build and push image
      #########################################
      - name: Build & Push Image
        run: |
          TAG=$(git rev-parse --short HEAD)
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE_NAME}:${TAG}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

      #########################################
      # Get cluster credentials
      #########################################
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials "$CLUSTER" \
            --region "$REGION" \
            --project "$PROJECT_ID"

      #########################################
      # Deploy manifests
      #########################################
      - name: Deploy to GKE
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|$IMAGE_URI|g" kub/deployment.yaml
          kubectl apply -f kub/
